{% extends "base.html" %}
{% block content %}
<div style="width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;">
  <!-- Barra superior minimalista: apenas menu -->
  <div style="width: 100%; display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px;">
    <button id="btn-menu" aria-label="menu" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">&#9776;</button>
  </div>

  {% if current_user.subscription_status == 'trial' and current_user.trial_ends_at %}
  <div style="width:100%;margin-bottom:8px;">
    <span style="display:inline-flex;align-items:center;gap:8px;background:#ecfdf5;border:1px solid #a7f3d0;color:#065f46;padding:6px 10px;border-radius:999px;font-size:0.85rem;">
      <span style="width:8px;height:8px;border-radius:999px;background:#10b981;"></span>
      Trial ativo até {{ current_user.trial_ends_at.strftime('%d/%m/%Y') }}
    </span>
  </div>
  {% endif %}

  

  <div style="width:100%;display:flex;align-items:center;gap:10px;overflow-x:auto;margin-bottom:12px;">
    {% for i in [-3,-2,-1,0,1,2,3] %}
      {% set d = data + timedelta(days=i) %}
      <a href="{{ url_for('main.dashboard', data=d.strftime('%Y-%m-%d'), profissional_id=profissional_id, status=status) }}" style="text-decoration:none;">
        {% if i==0 %}
  <div style="width:52px;min-width:52px;text-align:center;padding:8px 0;border:1px solid #e3e7eb;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:16px;background:#232323;color:#fff;">
          <div style="font-size:0.75rem;opacity:0.95;">{{ d.strftime('%a')|capitalize }}</div>
          <div style="font-size:1rem;font-weight:600;line-height:1.4;">{{ d.strftime('%d') }}</div>
        </div>
        {% else %}
  <div style="width:52px;min-width:52px;text-align:center;padding:8px 0;border:1px solid #e3e7eb;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:16px;background:#fff;color:#232323;">
          <div style="font-size:0.75rem;opacity:0.7;">{{ d.strftime('%a')|capitalize }}</div>
          <div style="font-size:1rem;font-weight:600;line-height:1.4;">{{ d.strftime('%d') }}</div>
        </div>
        {% endif %}
      </a>
    {% endfor %}
  </div>
  <!-- Botão de filtros abaixo das datas -->
  <div style="width:100%;display:flex;justify-content:flex-start;margin:6px 0 8px 0;">
    <button id="btn-filtros" style="padding:8px 12px;border:1px solid #e3e7eb;background:#fff;color:#232323;border-radius:8px;">Filtros</button>
  </div>

  <!-- Linha divisória sutil entre datas e cards -->
  <div style="width:100%;height:1px;background:#f0f2f4;margin:4px 0 8px 0;"></div>

  <form id="filters-form" method="get" action="{{ url_for('main.dashboard') }}" style="width: 100%; display: none; gap: 8px; margin-bottom: 12px;">
    <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
    <select name="profissional_id" style="flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid #e3e7eb;">
      <option value="">Todos os profissionais</option>
      {% for p in profissionais %}
      <option value="{{ p.id }}" {% if profissional_id and p.id == profissional_id %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
    <select name="status" style="flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid #e3e7eb;">
      <option value="ativos" {% if status == 'ativos' %}selected{% endif %}>Ativos</option>
      <option value="cancelados" {% if status == 'cancelados' %}selected{% endif %}>Cancelados</option>
    </select>
    <button type="submit" style="padding: 6px 12px; border-radius: 8px; background: #232323; color: #fff; border: none;">Filtrar</button>
  </form>

  

  <!-- Side Drawer -->
  <div id="side-drawer" style="display:none;position:fixed;top:0;right:0;width:260px;height:100%;background:#ffffff;border-left:1px solid #e3e7eb;box-shadow:0 4px 24px rgba(0,0,0,0.08);z-index:100;padding:16px;">
    <div style="font-weight:600;font-size:1.1rem;margin-bottom:12px;">Menu</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <a href="{{ url_for('main.dashboard_profile') }}" style="text-decoration:none;color:#232323;">Meu perfil</a>
      <a href="{{ url_for('main.services_list') }}" style="text-decoration:none;color:#232323;">Serviços</a>
      <a href="{{ url_for('main.billing') }}" style="text-decoration:none;color:#232323;">Plano e cobrança</a>
      {% if (current_user.plan or 'free')|lower != 'basic' %}
        <a href="{{ url_for('main.add_professional') }}" style="text-decoration:none;color:#232323;">Adicionar profissional</a>
      {% endif %}
      {% if (current_user.plan or 'free')|lower == 'basic' %}
        <a href="{{ url_for('main.locations_list') }}" style="text-decoration:none;color:#232323;">Locais de atendimento</a>
      {% endif %}
      <a href="{{ url_for('main.account_close') }}" style="text-decoration:none;color:#7c2d12;">Encerrar conta</a>
      <form method="post" action="{{ url_for('main.logout') }}">
        <button type="submit" style="width:100%;text-align:left;background:#fff;border:1px solid #e5e7eb;border-radius:8px;padding:8px 12px;color:#232323;">Sair</button>
      </form>
    </div>
  </div>

  <div style="width:100%;">
    {% set start_h = 8 %}
    {% set end_h = 21 %}
    {% set ppm = 1.4 %}
    {% set total_min = (end_h - start_h) * 60 %}
    {% set height_px = (total_min * ppm)|int %}

    <style>
      /* Layout da timeline */
      .tl-scroll{max-height:calc(100vh - 220px);overflow-y:auto;border:1px dashed #eef1f4;border-radius:12px;background:#f9fafb}
      .tl-row{display:flex;align-items:flex-start;gap:10px;min-width:0}
      .tl-hours{width:56px;position:sticky;left:0;z-index:2;background:linear-gradient(90deg,#f9fafb 85%, rgba(249,250,251,0));}
      .tl-hours-inner{position:relative}
      .tl-hour-label{position:absolute;right:8px;transform:translateY(-50%);color:#6b7280;font-size:0.8rem}
      .tl-content{position:relative;flex:1;padding:8px}
      .tl-line{position:absolute;left:8px;right:8px;height:1px;background:#eef1f4}

      /* Cards */
      .tl-card{position:absolute;left:12px;right:12px;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,0.04);padding:8px;overflow:hidden;border-left-width:4px;border-left-style:solid}
      .tl-card .head{display:flex;justify-content:space-between;align-items:center;gap:8px}
      .tl-card .title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:52%}
      .tl-card .service{color:#6b7280;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
      .tl-card .badge{min-width:24px;height:24px;border-radius:999px;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center}
      .tl-card .details{display:none;color:#232323;font-size:0.9rem;margin-top:6px}
      .tl-card .time{color:#6b7280;font-size:0.86rem;margin-bottom:4px}
  .tl-card.expanded{z-index:3;box-shadow:0 8px 20px rgba(0,0,0,0.12);overflow:visible}
      .tl-card.expanded .details{display:block}
      .tl-card .actions{position:absolute;right:8px;bottom:6px;display:none;gap:8px}
      .tl-card.expanded .actions{display:flex}

      /* Cores por profissional */
      .c0{border-left-color:#f59e0b}.c1{border-left-color:#3b82f6}.c2{border-left-color:#10b981}.c3{border-left-color:#ef4444}.c4{border-left-color:#8b5cf6}.c5{border-left-color:#f97316}
      .cb0{background:#f59e0b}.cb1{background:#3b82f6}.cb2{background:#10b981}.cb3{background:#ef4444}.cb4{background:#8b5cf6}.cb5{background:#f97316}
    </style>

    <div class="tl-scroll">
      <div class="tl-row">
        <div class="tl-hours">
          <div class="tl-hours-inner" data-height="{{ height_px }}">
            {% for h in range(start_h, end_h+1) %}
              {% set top_px = (((h - start_h) * 60) * ppm)|int %}
              <div class="tl-hour-label" data-top="{{ top_px }}">{{ '%02d' % h }}:00</div>
            {% endfor %}
          </div>
        </div>
        <div class="tl-content" data-height="{{ height_px }}">
          {% for h in range(start_h, end_h+1) %}
            {% set top_px = (((h - start_h) * 60) * ppm)|int %}
            <div class="tl-line" data-top="{{ top_px }}"></div>
          {% endfor %}

          {% for ag in agendamentos %}
            {% set dur = (ag.service.duration if ag.service else (ag.duracao or 0)) %}
            {% set mins_from_start = ((ag.appointment_time.strftime('%H')|int - start_h) * 60 + ag.appointment_time.strftime('%M')|int) %}
            {% set top_px = (mins_from_start * ppm)|int %}
            {% set height_card = (dur * ppm)|int %}
            {% set idx = (ag.professional.id or 0) % 6 %}
            <div class="tl-card c{{ idx }}" data-top="{{ top_px }}" data-h="{{ height_card }}">
              <div class="head">
                <div class="title">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div title="{{ ag.professional.name }}" class="badge cb{{ idx }}">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div class="service">{% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}</div>
              <div class="details">
                <div class="time">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                <div>Profissional: {{ ag.professional.name }}</div>
                {% if ag.location %}<div>Local: {{ ag.location.name }}</div>{% endif %}
              </div>
              <div class="actions">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:4px 8px;font-size:0.85rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    </div>

    <script>
      (function(){
        function applyPositions(){
          document.querySelectorAll('.tl-hours-inner,.tl-content').forEach(el=>{
            const h = el.getAttribute('data-height');
            if(h) el.style.height = h + 'px';
          });
          document.querySelectorAll('[data-top]').forEach(el=>{
            const t = el.getAttribute('data-top');
            if(t!==null) el.style.top = t + 'px';
          });
          document.querySelectorAll('.tl-card').forEach(el=>{
            const hh = el.getAttribute('data-h');
            if(!hh) return;
            if(el.classList.contains('expanded')){
              el.style.minHeight = hh + 'px';
              el.style.height = 'auto';
            } else {
              el.style.minHeight = '';
              el.style.height = hh + 'px';
            }
          });
        }
        applyPositions();
        window.addEventListener('resize', applyPositions);

        // Expand/Collapse cards on tap
        document.addEventListener('click', function(e){
          const card = e.target.closest('.tl-card');
          if(!card) return;
          // Toggle expanded class
          const nowExpanded = !card.classList.contains('expanded');
          card.classList.toggle('expanded');
          const hh = card.getAttribute('data-h');
          if(hh){
            if(nowExpanded){
              card.style.minHeight = hh + 'px';
              card.style.height = 'auto';
            } else {
              card.style.minHeight = '';
              card.style.height = hh + 'px';
            }
          }
        });
      })();
    </script>
  </div>
</div>

<!-- Floating Action Button (FAB) -->
<button id="fab" title="Adicionar" style="position:fixed;left:18px;bottom:18px;width:56px;height:56px;border-radius:50%;border:none;background:#232323;color:#fff;font-size:1.5rem;box-shadow:0 6px 16px rgba(0,0,0,0.2);cursor:pointer;z-index:90;">+</button>

<!-- Speed Dial -->
<div id="speed-dial" style="display:none;position:fixed;left:18px;bottom:86px;z-index:90;">
  <button id="btn-add-block" style="display:block;margin-bottom:8px;width:180px;border:none;border-radius:10px;background:#fff;color:#232323;border:1px solid #e3e7eb;padding:8px 12px;text-align:left;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;">Adicionar bloqueio</button>
  <button id="btn-add-appointment" style="display:block;width:180px;border:none;border-radius:10px;background:#fff;color:#232323;border:1px solid #e3e7eb;padding:8px 12px;text-align:left;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;">Adicionar agendamento</button>
</div>

<!-- Modal: Add Block -->
<div id="modal-block" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:95;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:16px;width:90%;max-width:400px;">
    <h3 style="margin:0 0 12px;">Adicionar bloqueio</h3>
    <form method="post" action="{{ url_for('main.dashboard_add_event') }}" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" name="tipo" value="bloqueio">
      <select name="profissional_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Profissional</option>
        {% for p in profissionais %}
          <option value="{{ p.id }}" {% if profissional_id and p.id==profissional_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
      <input type="date" name="data" value="{{ data.strftime('%Y-%m-%d') }}" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="time" name="hora" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="number" name="duracao" min="5" max="480" step="5" placeholder="Duração (min)" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="text" name="descricao" maxlength="100" placeholder="Descrição" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="close-block" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">Cancelar</button>
        <button type="submit" style="background:#232323;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Add Appointment -->
<div id="modal-appointment" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:95;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:16px;width:90%;max-width:420px;">
    <h3 style="margin:0 0 12px;">Adicionar agendamento</h3>
  <form method="post" action="{{ url_for('main.dashboard_add_event') }}" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
      <select id="ap-prof" name="profissional_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Profissional</option>
        {% for p in profissionais %}
          <option value="{{ p.id }}" {% if profissional_id and p.id==profissional_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
      {% if (current_user.plan or 'free')|lower == 'basic' %}
      <select id="ap-location" name="location_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Local</option>
        {% for loc in locations %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
        {% endfor %}
      </select>
      {% endif %}
      <select id="ap-service" name="service_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Serviço</option>
        {% for s in servicos %}
          <option value="{{ s.id }}">{{ s.name }} ({{ s.duration }}min)</option>
        {% endfor %}
      </select>
      <div>
        <div style="font-weight:600;margin-bottom:6px;">Cliente</div>
        <input type="hidden" name="customer_id" id="ap-customer-id">
        <input type="text" name="customer_name" id="ap-customer" placeholder="Nome do cliente" autocomplete="off" style="width:100%;padding:8px;border:1px solid #e3e7eb;border-radius:8px;">
        <div id="ap-cust-suggestions" style="margin-top:6px;display:none;border:1px solid #e3e7eb;border-radius:8px;overflow:hidden;background:#fff;"></div>
        <input type="tel" name="customer_phone" id="ap-phone" placeholder="Telefone (opcional)" style="margin-top:8px;width:100%;padding:8px;border:1px solid #e3e7eb;border-radius:8px;">
        <small style="color:#6b7280;">Digite para buscar clientes já atendidos; se não existir, criaremos um cadastro rápido.</small>
      </div>
      <select id="ap-time" name="hora" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Horário</option>
      </select>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="close-appt" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">Cancelar</button>
        <button type="submit" style="background:#232323;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const btnMenu = document.getElementById('btn-menu');
    const drawer = document.getElementById('side-drawer');
      const btnFiltros = document.getElementById('btn-filtros');
      const filtersForm = document.getElementById('filters-form');
    btnMenu && btnMenu.addEventListener('click', (e)=>{
      e.stopPropagation();
      drawer.style.display = (drawer.style.display==='block') ? 'none' : 'block';
    });
    // Evita fechar ao clicar dentro do drawer
    drawer && drawer.addEventListener('click', (e)=>{ e.stopPropagation(); });
    document.addEventListener('click', ()=>{ if(drawer) drawer.style.display='none'; });

      // Toggle filtros
      btnFiltros && btnFiltros.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!filtersForm) return;
        const isHidden = (filtersForm.style.display === 'none' || !filtersForm.style.display);
        filtersForm.style.display = isHidden ? 'flex' : 'none';
      });

    const fab = document.getElementById('fab');
    const dial = document.getElementById('speed-dial');
    const modalBlock = document.getElementById('modal-block');
    const modalAppt = document.getElementById('modal-appointment');
    const btnAddBlock = document.getElementById('btn-add-block');
    const btnAddAppointment = document.getElementById('btn-add-appointment');
    const closeBlock = document.getElementById('close-block');
    const closeAppt = document.getElementById('close-appt');

    fab && fab.addEventListener('click', (e)=>{
      e.stopPropagation();
      dial.style.display = (dial.style.display==='block') ? 'none' : 'block';
    });
    document.addEventListener('click', ()=>{ if(dial) dial.style.display='none'; });

    btnAddBlock && btnAddBlock.addEventListener('click', ()=>{ dial.style.display='none'; modalBlock.style.display='flex'; });
    btnAddAppointment && btnAddAppointment.addEventListener('click', ()=>{ dial.style.display='none'; modalAppt.style.display='flex'; updateTimes(); });
    closeBlock && closeBlock.addEventListener('click', ()=>{ modalBlock.style.display='none'; });
    closeAppt && closeAppt.addEventListener('click', ()=>{ modalAppt.style.display='none'; });

  async function updateTimes(){
      const prof = document.getElementById('ap-prof').value;
      const service = document.getElementById('ap-service').value;
      const locSel = document.getElementById('ap-location');
      const locationId = locSel ? locSel.value : '';
      const apTime = document.getElementById('ap-time');
  const date = '{{ data.strftime("%Y-%m-%d") }}';
      apTime.innerHTML = '<option value="">Horário</option>';
      if(!(prof && service)) return;
      try{
        const qs = new URLSearchParams({ profissional_id: prof, service_id: service, date });
        if(locationId) qs.set('location_id', locationId);
        const res = await fetch(`/dashboard/available_times?${qs.toString()}`);
        const data = await res.json();
        if(data && data.ok){
          data.slots.forEach(h => {
            const opt = document.createElement('option'); opt.value = h; opt.textContent = h; apTime.appendChild(opt);
          });
        }
      }catch(e){}
    }

  const apProf = document.getElementById('ap-prof');
    const apService = document.getElementById('ap-service');
    const apLocation = document.getElementById('ap-location');
    apProf && apProf.addEventListener('change', updateTimes);
    apService && apService.addEventListener('change', updateTimes);
    apLocation && apLocation.addEventListener('change', updateTimes);

    // Busca e sugestão de clientes (apenas já atendidos no salão)
    const inpCust = document.getElementById('ap-customer');
    const hidCust = document.getElementById('ap-customer-id');
    const sugBox = document.getElementById('ap-cust-suggestions');
    let tmr;
    function clearSug(){ sugBox.style.display='none'; sugBox.innerHTML=''; }
    function selectCust(c){ hidCust.value = c.id; inpCust.value = c.name; const ph=document.getElementById('ap-phone'); if(c.phone){ ph.value=c.phone; } clearSug(); }
    inpCust && inpCust.addEventListener('input', (e)=>{
      hidCust.value = '';
      const q = (e.target.value || '').trim();
      if(tmr) clearTimeout(tmr);
      if(!q){ clearSug(); return; }
      tmr = setTimeout(async ()=>{
        try{
          const res = await fetch('/api/customers/search?q=' + encodeURIComponent(q));
          const js = await res.json();
          if(js.ok){
            sugBox.innerHTML = '';
            js.results.forEach(c=>{
              const btn = document.createElement('button');
              btn.type='button';
              btn.style.cssText='display:block;width:100%;text-align:left;padding:8px 10px;border:none;background:#fff;border-bottom:1px solid #f1f1f1;cursor:pointer;';
              btn.textContent = c.name + (c.phone ? ' • ' + c.phone : '');
              btn.addEventListener('click', ()=> selectCust(c));
              sugBox.appendChild(btn);
            });
            sugBox.style.display = js.results.length ? 'block' : 'none';
          }
        }catch(e){ clearSug(); }
      }, 250);
    });
  })();
</script>
</div>

{% endblock %}
