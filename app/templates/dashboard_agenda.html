{% extends "base.html" %}
{% block content %}
<div style="width: 100%; max-width: 500px; margin: 0 auto; display: flex; flex-direction: column; align-items: center;">
  <!-- Barra superior minimalista: apenas menu -->
  <div style="width: 100%; display: flex; align-items: center; justify-content: flex-end; margin-bottom: 10px;">
    <button id="btn-menu" aria-label="menu" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">&#9776;</button>
  </div>

  

  <div style="width:100%;display:flex;align-items:center;gap:10px;overflow-x:auto;margin-bottom:12px;">
    {% for i in [-3,-2,-1,0,1,2,3] %}
      {% set d = data + timedelta(days=i) %}
      <a href="{{ url_for('main.dashboard', data=d.strftime('%Y-%m-%d'), profissional_id=profissional_id, status=status) }}" style="text-decoration:none;">
        {% if i==0 %}
  <div style="width:52px;min-width:52px;text-align:center;padding:8px 0;border:1px solid #e3e7eb;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:16px;background:#232323;color:#fff;">
          <div style="font-size:0.75rem;opacity:0.95;">{{ d.strftime('%a')|capitalize }}</div>
          <div style="font-size:1rem;font-weight:600;line-height:1.4;">{{ d.strftime('%d') }}</div>
        </div>
        {% else %}
  <div style="width:52px;min-width:52px;text-align:center;padding:8px 0;border:1px solid #e3e7eb;box-shadow:0 2px 8px rgba(0,0,0,0.04);border-radius:16px;background:#fff;color:#232323;">
          <div style="font-size:0.75rem;opacity:0.7;">{{ d.strftime('%a')|capitalize }}</div>
          <div style="font-size:1rem;font-weight:600;line-height:1.4;">{{ d.strftime('%d') }}</div>
        </div>
        {% endif %}
      </a>
    {% endfor %}
  </div>
  <!-- Botão de filtros abaixo das datas -->
  <div style="width:100%;display:flex;justify-content:flex-start;margin:6px 0 8px 0;">
    <button id="btn-filtros" style="padding:8px 12px;border:1px solid #e3e7eb;background:#fff;color:#232323;border-radius:8px;">Filtros</button>
  </div>

  <!-- Linha divisória sutil entre datas e cards -->
  <div style="width:100%;height:1px;background:#f0f2f4;margin:4px 0 8px 0;"></div>

  <form id="filters-form" method="get" action="{{ url_for('main.dashboard') }}" style="width: 100%; display: none; gap: 8px; margin-bottom: 12px;">
    <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
    <select name="profissional_id" style="flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid #e3e7eb;">
      <option value="">Todos os profissionais</option>
      {% for p in profissionais %}
      <option value="{{ p.id }}" {% if profissional_id and p.id == profissional_id %}selected{% endif %}>{{ p.name }}</option>
      {% endfor %}
    </select>
    <select name="status" style="flex: 1; padding: 6px 8px; border-radius: 8px; border: 1px solid #e3e7eb;">
      <option value="ativos" {% if status == 'ativos' %}selected{% endif %}>Ativos</option>
      <option value="cancelados" {% if status == 'cancelados' %}selected{% endif %}>Cancelados</option>
    </select>
    <button type="submit" style="padding: 6px 12px; border-radius: 8px; background: #232323; color: #fff; border: none;">Filtrar</button>
  </form>

  

  <!-- Side Drawer -->
  <div id="side-drawer" style="display:none;position:fixed;top:0;left:0;width:260px;height:100%;background:#ffffff;border-right:1px solid #e3e7eb;box-shadow:0 4px 24px rgba(0,0,0,0.08);z-index:100;padding:16px;">
    <div style="font-weight:600;font-size:1.1rem;margin-bottom:12px;">Menu</div>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <a href="{{ url_for('main.dashboard_profile') }}" style="text-decoration:none;color:#232323;">Meu perfil</a>
      <a href="{{ url_for('main.services_list') }}" style="text-decoration:none;color:#232323;">Serviços</a>
      {% if (current_user.plan or 'free')|lower != 'basic' %}
        <a href="{{ url_for('main.add_professional') }}" style="text-decoration:none;color:#232323;">Adicionar profissional</a>
      {% endif %}
      {% if (current_user.plan or 'free')|lower == 'basic' %}
        <a href="{{ url_for('main.locations_list') }}" style="text-decoration:none;color:#232323;">Locais de atendimento</a>
      {% endif %}
    </div>
  </div>

  <div style="width: 100%;">
    {% set hours = range(8, 21) %}
    {% for h in hours %}
    <div style="display:flex;gap:10px;align-items:flex-start;margin-bottom:8px;">
      <div style="width:52px;text-align:right;color:#6b7280;font-size:0.88rem;line-height:1.2rem;padding-top:8px;">{{ '%02d' % h }}:00</div>
      <div style="flex:1;position:relative;background:#f9fafb;border:1px dashed #eef1f4;border-radius:10px;padding:8px;min-height:52px;border-bottom:1px solid #f0f2f4;">
        {% set has_any = false %}
        {% for ag in agendamentos %}
          {% if ag.appointment_time.strftime('%H')|int == h %}
            {% set has_any = true %}
            {% set dur = (ag.service.duration if ag.service else (ag.duracao or 0)) %}
            {% set idx = (ag.professional.id or 0) % 6 %}
            {% if idx == 0 %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #f59e0b;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#f59e0b;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% elif idx == 1 %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #3b82f6;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#3b82f6;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% elif idx == 2 %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #10b981;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#10b981;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% elif idx == 3 %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #ef4444;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#ef4444;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% elif idx == 4 %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #8b5cf6;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#8b5cf6;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% else %}
            <div style="background:#fff;border:1px solid #e5e7eb;border-left:4px solid #f97316;border-radius:10px;padding:10px 10px;margin-bottom:8px;box-shadow:0 2px 10px rgba(0,0,0,0.04);overflow-wrap:anywhere;word-break:break-word;">
              <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap;">
                <div style="font-weight:600;">{% if ag.customer %}{{ ag.customer.name }}{% else %}Bloqueio{% endif %}</div>
                <div style="display:flex;align-items:center;gap:8px;">
                  <div style="color:#6b7280;font-size:0.84rem;">{{ ag.appointment_time.strftime('%H:%M') }} - {{ (ag.appointment_time + timedelta(minutes=dur)).strftime('%H:%M') }}</div>
                  <div title="{{ ag.professional.name }}" style="min-width:24px;height:24px;border-radius:999px;background:#f97316;color:#fff;font-size:0.75rem;display:flex;align-items:center;justify-content:center;">{{ ag.professional.name[0]|upper }}</div>
                </div>
              </div>
              <div style="color:#6b7280;font-size:0.92rem;margin-top:4px;">
                {% if ag.service %}{{ ag.service.name }}{% endif %}{% if ag.descricao %} • {{ ag.descricao }}{% endif %}
              </div>
              <div style="color:#232323;font-size:0.9rem;margin-top:4px;">Profissional: {{ ag.professional.name }}</div>
              {% if ag.location %}<div style="color:#232323;font-size:0.9rem;">Local: {{ ag.location.name }}</div>{% endif %}
              <div style="margin-top:8px;display:flex;gap:8px;justify-content:flex-end;">
                {% if ag.ativo %}
                <form method="post" action="{{ url_for('main.dashboard_cancelar_agendamento', agendamento_id=ag.id) }}" style="display:inline;">
                  <button type="submit" style="background:#fff;color:#d32f2f;border:1px solid #f3c1c1;border-radius:8px;padding:6px 10px;font-size:0.9rem;">Cancelar</button>
                </form>
                {% else %}
                <span style="color:#d32f2f;font-weight:500;">Cancelado</span>
                {% endif %}
              </div>
            </div>
            {% endif %}
          {% endif %}
        {% endfor %}
        
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Floating Action Button (FAB) -->
<button id="fab" title="Adicionar" style="position:fixed;left:18px;bottom:18px;width:56px;height:56px;border-radius:50%;border:none;background:#232323;color:#fff;font-size:1.5rem;box-shadow:0 6px 16px rgba(0,0,0,0.2);cursor:pointer;z-index:90;">+</button>

<!-- Speed Dial -->
<div id="speed-dial" style="display:none;position:fixed;left:18px;bottom:86px;z-index:90;">
  <button id="btn-add-block" style="display:block;margin-bottom:8px;width:180px;border:none;border-radius:10px;background:#fff;color:#232323;border:1px solid #e3e7eb;padding:8px 12px;text-align:left;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;">Adicionar bloqueio</button>
  <button id="btn-add-appointment" style="display:block;width:180px;border:none;border-radius:10px;background:#fff;color:#232323;border:1px solid #e3e7eb;padding:8px 12px;text-align:left;box-shadow:0 4px 12px rgba(0,0,0,0.08);cursor:pointer;">Adicionar agendamento</button>
</div>

<!-- Modal: Add Block -->
<div id="modal-block" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:95;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:16px;width:90%;max-width:400px;">
    <h3 style="margin:0 0 12px;">Adicionar bloqueio</h3>
    <form method="post" action="{{ url_for('main.dashboard_add_event') }}" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" name="tipo" value="bloqueio">
      <select name="profissional_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Profissional</option>
        {% for p in profissionais %}
          <option value="{{ p.id }}" {% if profissional_id and p.id==profissional_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
      <input type="date" name="data" value="{{ data.strftime('%Y-%m-%d') }}" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="time" name="hora" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="number" name="duracao" min="5" max="480" step="5" placeholder="Duração (min)" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <input type="text" name="descricao" maxlength="100" placeholder="Descrição" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="close-block" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">Cancelar</button>
        <button type="submit" style="background:#232323;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Add Appointment -->
<div id="modal-appointment" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:95;align-items:center;justify-content:center;">
  <div style="background:#fff;border-radius:12px;padding:16px;width:90%;max-width:420px;">
    <h3 style="margin:0 0 12px;">Adicionar agendamento</h3>
    <form method="post" action="{{ url_for('main.dashboard_create_appointment') }}" style="display:flex;flex-direction:column;gap:10px;">
      <input type="hidden" name="data" value="{{ data.strftime('%Y-%m-%d') }}">
      <select id="ap-prof" name="profissional_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Profissional</option>
        {% for p in profissionais %}
          <option value="{{ p.id }}" {% if profissional_id and p.id==profissional_id %}selected{% endif %}>{{ p.name }}</option>
        {% endfor %}
      </select>
      {% if (current_user.plan or 'free')|lower == 'basic' %}
      <select id="ap-location" name="location_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Local</option>
        {% for loc in locations %}
          <option value="{{ loc.id }}">{{ loc.name }}</option>
        {% endfor %}
      </select>
      {% endif %}
      <select id="ap-service" name="service_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Serviço</option>
        {% for s in servicos %}
          <option value="{{ s.id }}">{{ s.name }} ({{ s.duration }}min)</option>
        {% endfor %}
      </select>
      <select id="ap-customer" name="customer_id" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Cliente</option>
        {% for c in current_user.customers %}
          <option value="{{ c.id }}">{{ c.name }} ({{ c.phone }})</option>
        {% endfor %}
      </select>
      <select id="ap-time" name="hora" required style="padding:8px;border-radius:8px;border:1px solid #e3e7eb;">
        <option value="">Horário</option>
      </select>
      <div style="display:flex;justify-content:flex-end;gap:8px;">
        <button type="button" id="close-appt" style="background:#fff;border:1px solid #e3e7eb;border-radius:8px;padding:8px 12px;cursor:pointer;">Cancelar</button>
        <button type="submit" style="background:#232323;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer;">Salvar</button>
      </div>
    </form>
  </div>
</div>

<script>
  (function(){
    const btnMenu = document.getElementById('btn-menu');
    const drawer = document.getElementById('side-drawer');
      const btnFiltros = document.getElementById('btn-filtros');
      const filtersForm = document.getElementById('filters-form');
    btnMenu && btnMenu.addEventListener('click', (e)=>{
      e.stopPropagation();
      drawer.style.display = (drawer.style.display==='block') ? 'none' : 'block';
    });
    document.addEventListener('click', ()=>{ if(drawer) drawer.style.display='none'; });

      // Toggle filtros
      btnFiltros && btnFiltros.addEventListener('click', (e)=>{
        e.stopPropagation();
        if(!filtersForm) return;
        const isHidden = (filtersForm.style.display === 'none' || !filtersForm.style.display);
        filtersForm.style.display = isHidden ? 'flex' : 'none';
      });

    const fab = document.getElementById('fab');
    const dial = document.getElementById('speed-dial');
    const modalBlock = document.getElementById('modal-block');
    const modalAppt = document.getElementById('modal-appointment');
    const btnAddBlock = document.getElementById('btn-add-block');
    const btnAddAppointment = document.getElementById('btn-add-appointment');
    const closeBlock = document.getElementById('close-block');
    const closeAppt = document.getElementById('close-appt');

    fab && fab.addEventListener('click', (e)=>{
      e.stopPropagation();
      dial.style.display = (dial.style.display==='block') ? 'none' : 'block';
    });
    document.addEventListener('click', ()=>{ if(dial) dial.style.display='none'; });

    btnAddBlock && btnAddBlock.addEventListener('click', ()=>{ dial.style.display='none'; modalBlock.style.display='flex'; });
    btnAddAppointment && btnAddAppointment.addEventListener('click', ()=>{ dial.style.display='none'; modalAppt.style.display='flex'; updateTimes(); });
    closeBlock && closeBlock.addEventListener('click', ()=>{ modalBlock.style.display='none'; });
    closeAppt && closeAppt.addEventListener('click', ()=>{ modalAppt.style.display='none'; });

    async function updateTimes(){
      const prof = document.getElementById('ap-prof').value;
      const service = document.getElementById('ap-service').value;
      const locSel = document.getElementById('ap-location');
      const locationId = locSel ? locSel.value : '';
      const apTime = document.getElementById('ap-time');
  const date = '{{ data.strftime("%Y-%m-%d") }}';
      apTime.innerHTML = '<option value="">Horário</option>';
      if(!(prof && service)) return;
      try{
        const qs = new URLSearchParams({ profissional_id: prof, service_id: service, date });
        if(locationId) qs.set('location_id', locationId);
        const res = await fetch(`/dashboard/available_times?${qs.toString()}`);
        const data = await res.json();
        if(data && data.ok){
          data.slots.forEach(h => {
            const opt = document.createElement('option'); opt.value = h; opt.textContent = h; apTime.appendChild(opt);
          });
        }
      }catch(e){}
    }

    const apProf = document.getElementById('ap-prof');
    const apService = document.getElementById('ap-service');
    const apLocation = document.getElementById('ap-location');
    apProf && apProf.addEventListener('change', updateTimes);
    apService && apService.addEventListener('change', updateTimes);
    apLocation && apLocation.addEventListener('change', updateTimes);
  })();
</script>
</div>

{% endblock %}
